.PHONY: help build deploy-blue deploy-green switch-green rollback test logs-blue logs-green clean stop setup

.DEFAULT_GOAL := help

help:
	@echo 'ML Service Deployment - Available Commands'
	@echo ''
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  %-20s %s\n", $$1, $$2}'
	@echo ''

setup: ## Initial project setup
	@echo 'Running initial setup...'
	@chmod +x setup.sh
	@./setup.sh
	@echo 'Setup complete'

build: ## Build Docker images for both versions
	@echo 'Building Docker images...'
	@docker build -t ml-service:v1.0.0 --build-arg MODEL_VERSION=v1.0.0 .
	@docker build -t ml-service:v1.1.0 --build-arg MODEL_VERSION=v1.1.0 .
	@echo 'Images built successfully'
	@docker images | grep ml-service

build-blue: ## Build Blue version
	@echo 'Building Blue version...'
	@docker build -t ml-service:v1.0.0 --build-arg MODEL_VERSION=v1.0.0 .
	@echo 'Blue image built'

build-green: ## Build Green version
	@echo 'Building Green version...'
	@docker build -t ml-service:v1.1.0 --build-arg MODEL_VERSION=v1.1.0 .
	@echo 'Green image built'

deploy-blue: ## Deploy Blue environment
	@echo 'Deploying Blue environment...'
	@docker compose -f docker-compose.blue.yml up -d
	@echo 'Blue environment deployed'
	@echo 'Waiting for services to be ready...'
	@sleep 5
	@$(MAKE) health-blue

deploy-green: ## Deploy Green environment
	@echo 'Deploying Green environment...'
	@docker compose -f docker-compose.green.yml up -d
	@echo 'Green environment deployed'
	@echo 'Waiting for services to be ready...'
	@sleep 5
	@$(MAKE) health-green

switch-green: ## Switch traffic to Green
	@echo 'Switching traffic to Green...'
	@docker compose -f docker-compose.blue.yml down
	@docker compose -f docker-compose.green.yml up -d
	@echo 'Traffic switched to Green'
	@$(MAKE) health-check

switch-blue: ## Switch traffic to Blue
	@echo 'Switching traffic to Blue...'
	@docker compose -f docker-compose.green.yml down
	@docker compose -f docker-compose.blue.yml up -d
	@echo 'Traffic switched to Blue'
	@$(MAKE) health-check

rollback: switch-blue ## Rollback to Blue environment
	@echo 'Rolled back to stable Blue version'

health-check: ## Check health of current active environment
	@echo 'Checking service health...'
	@curl -s http://localhost/health | python3 -m json.tool || echo 'Health check failed'

health-blue: ## Check Blue environment health
	@echo 'Checking Blue environment...'
	@curl -s http://localhost:8081/health | python3 -m json.tool || echo 'Blue health check failed'

health-green: ## Check Green environment health
	@echo 'Checking Green environment...'
	@curl -s http://localhost:8082/health | python3 -m json.tool || echo 'Green health check failed'

test: ## Run automated tests
	@echo 'Running tests...'
	@chmod +x test_service.sh
	@./test_service.sh http://localhost
	@echo 'Tests completed'

test-predict: ## Test prediction endpoint
	@echo 'Testing prediction endpoint...'
	@curl -X POST http://localhost/predict \
		-H "Content-Type: application/json" \
		-d '{"features": [5.1, 3.5, 1.4, 0.2]}' | python3 -m json.tool

logs: ## View logs from active environment
	@echo 'Viewing logs...'
	@docker compose -f docker-compose.blue.yml logs -f 2>/dev/null || \
	 docker compose -f docker-compose.green.yml logs -f 2>/dev/null || \
	 echo 'No active environment found'

logs-blue: ## View Blue environment logs
	@echo 'Blue environment logs:'
	@docker compose -f docker-compose.blue.yml logs -f

logs-green: ## View Green environment logs
	@echo 'Green environment logs:'
	@docker compose -f docker-compose.green.yml logs -f

ps: ## Show running containers
	@echo 'Running containers:'
	@docker ps --filter "name=ml-service" --filter "name=nginx"

status: ## Show deployment status
	@echo 'Deployment Status:'
	@echo ''
	@echo 'Blue Environment:'
	@docker compose -f docker-compose.blue.yml ps 2>/dev/null || echo '  Not running'
	@echo ''
	@echo 'Green Environment:'
	@docker compose -f docker-compose.green.yml ps 2>/dev/null || echo '  Not running'
	@echo ''
	@echo 'Active Version:'
	@curl -s http://localhost/health 2>/dev/null | python3 -c "import sys, json; print('  ' + json.load(sys.stdin).get('version', 'Unknown'))" || echo '  Service not accessible'

stop: ## Stop all environments
	@echo 'Stopping all environments...'
	@docker compose -f docker-compose.blue.yml down 2>/dev/null || true
	@docker compose -f docker-compose.green.yml down 2>/dev/null || true
	@echo 'All environments stopped'

restart-blue: ## Restart Blue environment
	@echo 'Restarting Blue environment...'
	@docker compose -f docker-compose.blue.yml restart
	@echo 'Blue restarted'

restart-green: ## Restart Green environment
	@echo 'Restarting Green environment...'
	@docker compose -f docker-compose.green.yml restart
	@echo 'Green restarted'

clean: stop ## Stop all and remove containers, images
	@echo 'Cleaning up...'
	@docker rmi ml-service:v1.0.0 ml-service:v1.1.0 2>/dev/null || true
	@docker system prune -f
	@echo 'Cleanup complete'

clean-all: clean ## Remove everything including volumes
	@echo 'Deep cleaning...'
	@docker system prune -a -f --volumes
	@echo 'Deep cleanup complete'

shell-blue: ## Open shell in Blue container
	@docker exec -it ml-service-blue /bin/bash

shell-green: ## Open shell in Green container
	@docker exec -it ml-service-green /bin/bash

nginx-reload-blue: ## Reload Blue Nginx configuration
	@docker exec nginx-blue nginx -s reload
	@echo 'Blue Nginx reloaded'

nginx-reload-green: ## Reload Green Nginx configuration
	@docker exec nginx-green nginx -s reload
	@echo 'Green Nginx reloaded'

verify: ## Verify setup and configuration
	@echo 'Verifying setup...'
	@chmod +x verify_setup.sh
	@./verify_setup.sh http://localhost

benchmark: ## Run performance benchmark
	@echo 'Running benchmark (100 requests)...'
	@for i in $$(seq 1 100); do \
		curl -s -X POST http://localhost/predict \
			-H "Content-Type: application/json" \
			-d '{"features": [5.1, 3.5, 1.4, 0.2]}' > /dev/null; \
	done
	@echo 'Benchmark complete'

dev-setup: ## Setup development environment
	@echo 'Setting up development environment...'
	@python3 -m venv venv
	@. venv/bin/activate && pip install -r app/requirements.txt
	@echo 'Development environment ready'
	@echo 'Activate with: source venv/bin/activate'

lint: ## Run code linting
	@echo 'Running linters...'
	@. venv/bin/activate && pip install flake8 black || true
	@. venv/bin/activate && black app/ --check || true
	@. venv/bin/activate && flake8 app/ || true

format: ## Format code
	@echo 'Formatting code...'
	@. venv/bin/activate && pip install black || true
	@. venv/bin/activate && black app/
	@echo 'Code formatted'

git-setup: ## Initialize git repository
	@echo 'Initializing git repository...'
	@git init
	@git add .
	@git commit -m "Initial commit: ML service with Blue-Green deployment"
	@echo 'Git repository initialized'
	@echo 'Add remote with: git remote add origin <your-repo-url>'

scenario-new-deploy: build deploy-blue test ## Scenario: New deployment from scratch
	@echo 'New deployment complete'

scenario-update: build-green deploy-green test switch-green ## Scenario: Deploy new version
	@echo 'Updated to new version'

scenario-rollback: rollback test ## Scenario: Rollback to previous version
	@echo 'Rolled back to stable version'

monitor: ## Monitor service in real-time
	@echo 'Monitoring service...'
	@watch -n 2 'curl -s http://localhost/health | python3 -m json.tool'

docs: ## Generate documentation
	@echo 'Documentation available:'
	@echo '  README.md - Main documentation'
	@echo '  QUICKSTART.md - Quick start guide'
	@echo '  DEPLOYMENT_GUIDE.md - Detailed deployment guide'

version: ## Show current deployed version
	@curl -s http://localhost/health 2>/dev/null | python3 -c "import sys, json; print('Current version: ' + json.load(sys.stdin).get('version', 'Unknown'))" || echo 'Service not accessible'

info: ## Show project information
	@echo 'Project Information:'
	@echo '  Name: ML Service with Blue-Green Deployment'
	@echo '  Blue Version: v1.0.0'
	@echo '  Green Version: v1.1.0'
	@echo '  API Port: 80 (Nginx)'
	@echo '  Blue Direct: 8081'
	@echo '  Green Direct: 8082'
	@echo ''
	@$(MAKE) version
